services:
  relay:
    image: scsibug/nostr-rs-relay:latest
    ports:
      - "${NOSTR_PUBLISH_RELAY_PORT:-8080}:8080"
    volumes:
      - ./relay-config.toml:/usr/src/app/config.toml:ro
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8080'"]
      interval: 2s
      timeout: 2s
      retries: 10

  bunker:
    build:
      context: ./nak
      dockerfile: Dockerfile
    command:
      - bunker
      - "--sec"
      - "0000000000000000000000000000000000000000000000000000000000000001"
      - "--authorized-keys"
      - "c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5"
      - "--authorized-secrets"
      - "testauth"
      - "ws://relay:8080"
    depends_on:
      relay:
        condition: service_healthy
    restart: on-failure

  blossom:
    image: ghcr.io/hzrd149/blossom-server:4.4
    ports:
      - "${NOSTR_PUBLISH_BLOSSOM_PORT:-3000}:3000"
    volumes:
      - ./blossom-config.yml:/app/config.yml:ro
      - blossom_data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000 || exit 1"]
      interval: 2s
      timeout: 5s
      retries: 10
    depends_on:
      relay:
        condition: service_healthy

  njump:
    build:
      context: ./njump
    ports:
      - "${NOSTR_PUBLISH_NJUMP_PORT:-2999}:2999"
    environment:
      - DOMAIN=localhost:${NOSTR_PUBLISH_NJUMP_PORT:-2999}
      - RELAY_CONFIG_PATH=/app/relay-config.json
    volumes:
      - ./njump-relay-config.json:/app/relay-config.json:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:2999 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
    depends_on:
      relay:
        condition: service_healthy

volumes:
  blossom_data:

networks:
  default:
    name: nostr-publish-test
